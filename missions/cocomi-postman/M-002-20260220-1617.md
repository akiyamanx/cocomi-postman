# 📮 COCOMI Postman ミッション指示書
# M-007: Phase C — Retry機構＋--continue自動継続＋エラーレポート強化

**ミッションタイプ:** feature-add
**対象プロジェクト:** cocomi-postman
**優先度:** 高
**作成日:** 2026-02-20
**作成者:** アキヤ & クロちゃん（Claude Opus 4.6）

---

## 📋 ミッション概要

Claude Code実行が失敗した時の自動リトライ機構、--continue自動継続、
およびAI間連携を重視した二層構造エラーレポートを実装する。

現在のexecutor.shではClaude Codeの実行が失敗すると即座にエラーレポートを出して終了する。
Phase Cでは「自動で3回リトライ→それでもダメなら--continueで継続試行→
最終的に失敗した場合はClaude Code自身に自己分析させてレポートに含める」仕組みを追加する。

---

## 📁 対象ファイル

### 新規作成
- `core/retry.sh` — リトライ＋continue＋自己分析＋二層レポート生成

### 修正
- `core/executor.sh` — run_single_mission()からretry.shを呼び出すように変更

---

## 🔧 実装内容

### 1. core/retry.sh（新規作成）

#### ファイル先頭コメント
```bash
#!/bin/bash
# shellcheck disable=SC2155,SC2164,SC2162
# このファイルは: COCOMI Postman リトライ＆自動継続エンジン
# Claude Code実行失敗時の自動リトライ、--continue継続、自己分析レポート生成
# v1.5 追加 2026-02-20 - Phase C: Retry + Continue + AI Self-Analysis
```

#### 関数: run_with_retry()

**引数:**
- $1: MISSION_FILE（指示書のフルパス）
- $2: MISSION_NAME（ミッション名）
- $3: LOG_FILE（ログファイルのパス）
- $4: CURRENT_REPO_PATH（対象プロジェクトのリポジトリパス）

**処理フロー:**

```
Step 1: Claude Code実行（初回）
  ↓ 成功(EXIT_CODE=0) → return 0
  ↓ 失敗
Step 2: リトライループ（最大3回）
  - 5秒wait
  - claude -p で再実行（同じ指示書）
  - 成功 → return 0
  - 3回全部失敗 → Step 3へ
Step 3: --continue試行（1回）
  - claude --continue で途中から継続を試みる
  - 成功 → return 0
  - 失敗 → Step 4へ
Step 4: 自己分析（Claude Codeに失敗原因を聞く）
  - claude -p で以下のプロンプトを送る:
    "The previous task failed. Analyze the failure:
    - What was attempted
    - How far it progressed
    - Root cause of failure
    - Which file and line caused the issue
    - Suggested fix for the next attempt
    Report in English. Be concise and technical."
  - 回答をANALYSIS変数に格納
Step 5: 二層構造エラーレポート生成
  - return 1
```

#### Claude Code実行コマンド（初回＋リトライ共通）

```bash
claude -p --allowedTools "Read,Write,Edit,Bash(cat *),Bash(ls *),Bash(find *),Bash(head *),Bash(tail *),Bash(wc *),Bash(grep *),Bash(node *),Bash(npm *)" < "$MISSION_FILE" >> "$LOG_FILE" 2>&1
```

※ 現在のexecutor.shと同じallowedToolsを使うこと

#### --continue実行コマンド

```bash
claude --continue >> "$LOG_FILE" 2>&1
```

#### 自己分析実行コマンド

```bash
ANALYSIS=$(claude -p "The previous task failed. Analyze the failure:
- What was attempted
- How far it progressed  
- Root cause of failure
- Which file and line caused the issue
- Suggested fix for the next attempt
Report in English. Be concise and technical." --continue 2>&1)
```

#### 二層構造エラーレポート生成関数: generate_error_report()

**引数:**
- $1: MISSION_NAME
- $2: CURRENT_PROJECT_NAME（プロジェクト名）
- $3: RETRY_COUNT（リトライ回数）
- $4: CONTINUE_TRIED（continueを試みたか: true/false）
- $5: ANALYSIS（Claude Codeの自己分析テキスト）
- $6: LOG_FILE
- $7: ERROR_REPORT_PATH（出力先パス）

**レポート構造（.mdファイル）:**

```markdown
# ❌ Error Report: {MISSION_NAME}

## 📱 アキヤ向けサマリー（日本語）
- **状態:** ❌ リトライ{RETRY_COUNT}回＋continue{tried/未実施}→全部失敗
- **プロジェクト:** {CURRENT_PROJECT_NAME}
- **発生日時:** {date}
- **一言:** （ANALYSISの1行目を日本語要約 — ※この部分はANALYSISのSuggested fixから簡易生成）
- **次のアクション:** クロちゃんにこのレポートを見せてね！

---

## 🤖 AI Failure Analysis (for Claude/Gemini/GPT)

### Execution Context
- **Mission:** {MISSION_NAME}
- **Project:** {CURRENT_PROJECT_NAME}
- **Retry attempts:** {RETRY_COUNT}/3
- **Continue attempted:** {CONTINUE_TRIED}
- **Timestamp:** {ISO8601 datetime}
- **Exit code:** {EXIT_CODE}

### Claude Code Self-Analysis
{ANALYSIS}

### Execution Log (last 50 lines)
```
{tail -50 LOG_FILE}
```

### Full Log Path
{LOG_FILE}
```

#### 「一言」の生成方法

ANALYSISテキストから "Suggested fix" の行を抽出し、簡易的に日本語説明を付ける。
複雑な翻訳は不要。以下のようなシンプルな形式でOK:

```bash
# ANALYSISからSuggested fix行を抽出
SUGGESTED_FIX=$(echo "$ANALYSIS" | grep -i "suggested fix" | head -1)
if [ -z "$SUGGESTED_FIX" ]; then
    HITOKOTO="Claude Codeが作業中にエラーが発生しました"
else
    HITOKOTO="$SUGGESTED_FIX"
fi
```

---

### 2. core/executor.sh の修正

#### 修正箇所: run_single_mission() 関数内

**変更前（現在のSTEP 2部分）:**
```bash
# STEP 2: Claude Codeで作業（gitはさせない！）
echo -e "  ${YELLOW}📦 Claude Code実行中...${NC}"
claude -p --allowedTools "Read,Write,Edit,Bash(cat *),Bash(ls *),Bash(find *),Bash(head *),Bash(tail *),Bash(wc *),Bash(grep *),Bash(node *),Bash(npm *)" < "$MISSION_FILE" >> "$LOG_FILE" 2>&1
local EXIT_CODE=$?
```

**変更後:**
```bash
# STEP 2: Claude Codeで作業（リトライ機構付き）
echo -e "  ${YELLOW}📦 Claude Code実行中...${NC}"
source "$POSTMAN_DIR/core/retry.sh"
run_with_retry "$MISSION_FILE" "$MISSION_NAME" "$LOG_FILE" "$CURRENT_REPO_PATH"
local EXIT_CODE=$?
```

#### 変更前（STEP 3のエラー処理部分）:**

**変更前:**
```bash
else
    echo -e "  ${RED}📦 エラー発生${NC}"
    git_push_project "$CURRENT_REPO_PATH" "⚠ $MISSION_NAME 途中成果"

    mkdir -p "$POSTMAN_DIR/errors/$CURRENT_PROJECT"
    cat > "$POSTMAN_DIR/errors/$CURRENT_PROJECT/E-${MISSION_NAME#M-}.md" << EOF
# ❌ エラーレポート
- **ミッション:** ${MISSION_NAME}
- **プロジェクト:** ${CURRENT_PROJECT_NAME}
- **発生日時:** $(date '+%Y-%m-%d %H:%M')
- **終了コード:** ${EXIT_CODE}
EOF
    echo -e "  ${RED}❌ $MISSION_NAME エラー${NC}"

    # v1.3追加 - LINE通知（エラー時）
    if type notify_mission_result &>/dev/null; then
        notify_mission_result "$CURRENT_PROJECT_NAME" "$MISSION_NAME" "error" "Claude Code実行エラー"
    fi
fi
```

**変更後:**
```bash
else
    echo -e "  ${RED}📦 エラー発生（リトライ済み）${NC}"
    git_push_project "$CURRENT_REPO_PATH" "⚠ $MISSION_NAME 途中成果"

    # retry.shが生成したエラーレポートがERROR_REPORT変数にある
    mkdir -p "$POSTMAN_DIR/errors/$CURRENT_PROJECT"
    local ERROR_REPORT_PATH="$POSTMAN_DIR/errors/$CURRENT_PROJECT/E-${MISSION_NAME#M-}.md"

    # retry.shのgenerate_error_report()でレポート生成
    generate_error_report "$MISSION_NAME" "$CURRENT_PROJECT_NAME" "$RETRY_COUNT" "$CONTINUE_TRIED" "$ANALYSIS" "$LOG_FILE" "$ERROR_REPORT_PATH"

    echo -e "  ${RED}❌ $MISSION_NAME エラー（リトライ${RETRY_COUNT}回実施済み）${NC}"

    # v1.3追加 - LINE通知（エラー時）— リトライ情報付き
    if type notify_mission_result &>/dev/null; then
        notify_mission_result "$CURRENT_PROJECT_NAME" "$MISSION_NAME" "error" "リトライ${RETRY_COUNT}回+continue全て失敗。レポートをクロちゃんに見せてね！"
    fi
fi
```

#### 重要: retry.shからexecutor.shへの変数受け渡し

run_with_retry()は以下のグローバル変数をセットしてからreturnする:
- `RETRY_COUNT` — 実行したリトライ回数（0-3）
- `CONTINUE_TRIED` — continueを試みたか（"true" or "false"）
- `ANALYSIS` — Claude Codeの自己分析テキスト（失敗時のみ）

※ sourceで読み込んでいるのでグローバル変数でOK

---

### 3. LINE通知の修正

成功時のLINE通知メッセージも、リトライで成功した場合は回数を含める:

```bash
# リトライなしで成功
"success" → 現在のまま

# リトライ後に成功
"success" → "✅ ${MISSION_NAME} 完了！（リトライ${RETRY_COUNT}回目で成功）"
```

---

## ✅ 完了条件

1. `core/retry.sh` が新規作成されている
2. `core/executor.sh` の `run_single_mission()` がretry.shを使うように修正されている
3. 各ファイルにバージョン番号（v1.5）と日本語コメントが入っている
4. 各ファイルの先頭に「このファイルは何をするか」の日本語コメントがある
5. 各ファイルが500行以内である
6. ShellCheckでエラーが出ない（SC1091,SC2034除外）
7. 既存の成功フロー（Claude Code一発成功のケース）が壊れていない
8. git commit: "v1.5 feat: Phase C - Retry機構+continue自動継続+AI自己分析エラーレポート"

---

## ⚠️ 注意事項

- 既存の成功パターン（EXIT_CODE=0で即完了）は絶対に壊さないこと
- retry.shの各関数はexecutor.shからsourceで読み込まれる前提
- リトライ間のwaitは5秒（API負荷対策）
- --continueはリトライ3回失敗後に1回だけ試行
- 自己分析もclaude -pで実行するが、これ自体が失敗した場合は空文字でOK（レポートには「分析失敗」と記載）
- ログファイルへの書き込みは全て追記（>>）モード


