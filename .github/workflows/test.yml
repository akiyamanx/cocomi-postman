# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯COCOMI Postmanã®è‡ªå‹•ãƒ†ã‚¹ãƒˆå¯©æŸ»ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# v1.4è¿½åŠ  - GitHub Actionsãƒ†ã‚¹ãƒˆå¯©æŸ»ã‚·ã‚¹ãƒ†ãƒ 
name: ğŸ“® COCOMI Postman ãƒ†ã‚¹ãƒˆå¯©æŸ»

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cocomi-test:
    runs-on: ubuntu-latest
    name: ğŸ” COCOMIãƒ†ã‚¹ãƒˆå¯©æŸ»

    steps:
    # â‘  ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰å–å¾—
      uses: actions/checkout@v4

    # â‘¡ ShellCheck æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
    - name: ğŸ› ShellCheck - ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      run: |
        sudo apt-get install -y shellcheck
        echo "=== ShellCheck é–‹å§‹ ==="
        ERRORS=0
        for f in $(find . -name "*.sh" -not -path "./.git/*"); do
          echo "ãƒã‚§ãƒƒã‚¯ä¸­: $f"
          if shellcheck -e SC1091,SC2034 "$f"; then
            echo "  âœ… $f OK"
          else
            echo "  âŒ $f ã«ã‚¨ãƒ©ãƒ¼ã‚ã‚Š"
            ERRORS=$((ERRORS + 1))
          fi
        done
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ ShellCheck: ${ERRORS}ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ãƒ©ãƒ¼"
          exit 1
        fi
        echo "âœ… ShellCheck: å…¨ãƒ•ã‚¡ã‚¤ãƒ«é€šéï¼"

    # â‘¢ COCOMIãƒ«ãƒ¼ãƒ« - 500è¡Œãƒã‚§ãƒƒã‚¯
    - name: ğŸ“ COCOMIãƒ«ãƒ¼ãƒ« - 500è¡Œä»¥å†…ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== 500è¡Œãƒã‚§ãƒƒã‚¯ é–‹å§‹ ==="
        ERRORS=0
        for f in $(find . -name "*.sh" -not -path "./.git/*"); do
          lines=$(wc -l < "$f")
          if [ "$lines" -gt 500 ]; then
            echo "  âŒ $f: ${lines}è¡Œï¼ˆ500è¡Œä»¥å†…ã«ã—ã¦ã­ï¼ï¼‰"
            ERRORS=$((ERRORS + 1))
          else
            echo "  âœ… $f: ${lines}è¡Œ OK"
          fi
        done
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ 500è¡Œãƒ«ãƒ¼ãƒ«: ${ERRORS}ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¶…é"
          exit 1
        fi
        echo "âœ… 500è¡Œãƒ«ãƒ¼ãƒ«: å…¨ãƒ•ã‚¡ã‚¤ãƒ«é€šéï¼"

    # â‘£ COCOMIãƒ«ãƒ¼ãƒ« - ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
    - name: ğŸ“ COCOMIãƒ«ãƒ¼ãƒ« - ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ
      run: |
        echo "=== å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ é–‹å§‹ ==="
        ERRORS=0
        for f in $(find . -name "*.sh" -not -path "./.git/*"); do
          # shebangè¡Œï¼ˆ#!/...ï¼‰ã®å¾Œã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ#ã§å§‹ã¾ã‚‹è¡Œï¼‰ãŒã‚ã‚‹ã‹
          # å…ˆé ­5è¡Œä»¥å†…ã«æ—¥æœ¬èªorè‹±èªã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°OK
          if head -5 "$f" | tail -4 | grep -q "^#"; then
            echo "  âœ… $f: å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ OK"
          else
            echo "  âŒ $f: ãƒ•ã‚¡ã‚¤ãƒ«èª¬æ˜ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ã‚ˆï¼"
            ERRORS=$((ERRORS + 1))
          fi
        done
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ: ${ERRORS}ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœªè¨˜è¼‰"
          exit 1
        fi
        echo "âœ… å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ: å…¨ãƒ•ã‚¡ã‚¤ãƒ«é€šéï¼"

    # â‘¤ COCOMIãƒ«ãƒ¼ãƒ« - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãƒã‚§ãƒƒã‚¯
    - name: ğŸ“ COCOMIãƒ«ãƒ¼ãƒ« - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·
      run: |
        echo "=== ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãƒã‚§ãƒƒã‚¯ é–‹å§‹ ==="
        ERRORS=0
        for f in $(find . -name "*.sh" -not -path "./.git/*"); do
          if grep -q "v[0-9]" "$f"; then
            VER=$(grep -o "v[0-9][0-9.]*" "$f" | head -1)
            echo "  âœ… $f: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${VER} OK"
          else
            echo "  âŒ $f: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒãªã„ã‚ˆï¼"
            ERRORS=$((ERRORS + 1))
          fi
        done
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·: ${ERRORS}ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœªè¨˜è¼‰"
          exit 1
        fi
        echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·: å…¨ãƒ•ã‚¡ã‚¤ãƒ«é€šéï¼"

    # â‘¥ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ - æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    - name: ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ - æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«æ¼æ´©ãƒã‚§ãƒƒã‚¯
      run: |
        echo "=== æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ é–‹å§‹ ==="
        ERRORS=0
        # config.jsonãŒãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã¦ã„ãªã„ã‹
        if [ -f config.json ]; then
          echo "  âŒ config.jsonãŒãƒªãƒã‚¸ãƒˆãƒªã«å…¥ã£ã¦ã‚‹ï¼ãƒˆãƒ¼ã‚¯ãƒ³æ¼æ´©å±é™ºï¼"
          ERRORS=$((ERRORS + 1))
        else
          echo "  âœ… config.json ã¯é™¤å¤–ã•ã‚Œã¦ã‚‹ OK"
        fi
        # APIã‚­ãƒ¼ã‚„ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹
        for f in $(find . -name "*.sh" -not -path "./.git/*"); do
          if grep -qE "(ghp_|sk-ant-|xoxb-|Bearer )" "$f"; then
            echo "  âŒ $f: APIã‚­ãƒ¼ã‚‰ã—ãæ–‡å­—åˆ—ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã‚‹ï¼"
            ERRORS=$((ERRORS + 1))
          fi
        done
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${ERRORS}ä»¶ã®å•é¡Œ"
          exit 1
        fi
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å…¨ãƒã‚§ãƒƒã‚¯é€šéï¼"

    # â‘¦ ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
    - name: ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“® COCOMI Postman ãƒ†ã‚¹ãƒˆå¯©æŸ»å®Œäº†ï¼"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  ğŸ› ShellCheckæ§‹æ–‡ãƒã‚§ãƒƒã‚¯"
        echo "  ğŸ“ 500è¡Œãƒ«ãƒ¼ãƒ«"
        echo "  ğŸ“ å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ"
        echo "  ğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·"
        echo "  ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # â‘§ LINEé€šçŸ¥ï¼ˆæˆåŠŸæ™‚ï¼‰
    - name: ğŸ“± LINEé€šçŸ¥ - æˆåŠŸ
      if: success()
      env:
        LINE_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
      run: |
        if [ -n "$LINE_TOKEN" ] && [ -n "$LINE_USER_ID" ]; then
          COMMIT_MSG=$(git log -1 --pretty=%s)
          curl -s -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LINE_TOKEN}" \
            -d "{
              \"to\": \"${LINE_USER_ID}\",
              \"messages\": [{
                \"type\": \"text\",
                \"text\": \"ğŸ“® COCOMI Postman ãƒ†ã‚¹ãƒˆå¯©æŸ»çµæœ\n\nâœ… å…¨ãƒ†ã‚¹ãƒˆé€šéï¼\n\nã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_MSG}\n\nğŸ› ShellCheck OK\nğŸ“ 500è¡Œãƒ«ãƒ¼ãƒ« OK\nğŸ“ å…ˆé ­ã‚³ãƒ¡ãƒ³ãƒˆ OK\nğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå· OK\nğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ OK\n\nğŸ“ https://github.com/akiyamanx/cocomi-postman/actions\"
              }]
            }"
          echo "ğŸ“± LINEé€šçŸ¥é€ä¿¡å®Œäº†"
        else
          echo "âš ï¸ LINEè¨­å®šãªã—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
        fi

    # â‘¨ LINEé€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰ # v1.6 å¤±æ•—æ™‚ã«ã‚‚ğŸ“ãƒªãƒ³ã‚¯è¿½åŠ 
    - name: ğŸ“± LINEé€šçŸ¥ - å¤±æ•—
      if: failure()
      env:
        LINE_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_USER_ID: ${{ secrets.LINE_USER_ID }}
      run: |
        if [ -n "$LINE_TOKEN" ] && [ -n "$LINE_USER_ID" ]; then
          COMMIT_MSG=$(git log -1 --pretty=%s)
          curl -s -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${LINE_TOKEN}" \
            -d "{
              \"to\": \"${LINE_USER_ID}\",
              \"messages\": [{
                \"type\": \"text\",
                \"text\": \"ğŸ“® COCOMI Postman ãƒ†ã‚¹ãƒˆå¯©æŸ»çµæœ\n\nâŒ ãƒ†ã‚¹ãƒˆå¤±æ•—ï¼\n\nã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_MSG}\n\nGitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã­ï¼\n\nğŸ“ https://github.com/akiyamanx/cocomi-postman/actions\"
              }]
            }"
          echo "ğŸ“± LINEé€šçŸ¥é€ä¿¡å®Œäº†"
        else
          echo "âš ï¸ LINEè¨­å®šãªã—ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
        fi
